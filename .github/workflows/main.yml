
name: Build Windows EXE (CHAP1_v19_clean)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Ensure folders & placeholders
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path assets | Out-Null
          New-Item -ItemType Directory -Force -Path data | Out-Null
          if (-not (Test-Path data\.gitkeep)) { Add-Content -Path data\.gitkeep -Value "" }

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r requirements.txt
          pip install pyinstaller pillow

      - name: Convert provided PNG to ICO (PowerShell here-string)
        shell: pwsh
        run: |
          $code = @"
from PIL import Image
from pathlib import Path
p = Path('assets/chap1_provided.png')
if p.exists() and p.stat().st_size > 0:
    img = Image.open(p).convert('RGBA')
    sizes = [(16,16),(32,32),(48,48),(64,64),(128,128),(256,256)]
    img.save('assets/chap1.ico', sizes=sizes)
    print('ICO created at assets/chap1.ico')
else:
    print('No provided PNG, skipping ICO conversion.')
"@
          $code | Set-Content -Path convert_ico.py -Encoding UTF8
          python convert_ico.py

      - name: Build EXE (no UPX)
        shell: cmd
        run: |
          python -m PyInstaller --noconsole --onefile --name CHAP1_v19_clean --icon assets/chap1.ico ^
            --hidden-import sounddevice ^
            --hidden-import faster_whisper ^
            --hidden-import ctranslate2 ^
            --collect-all faster_whisper ^
            --collect-all ctranslate2 ^
            --collect-all sounddevice ^
            --collect-submodules numpy ^
            --exclude-module numpy.tests ^
            --exclude-module pip ^
            --add-data "assets;assets" ^
            --add-data "data;data" ^
            run.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CHAP1_v19_clean
          path: dist/CHAP1_v19_clean.exe
